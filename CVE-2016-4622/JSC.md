# JavascriptCore

Some notes about ``JSC`` as I understand it from source

The basic "format" is the ``JSValue``

## Live session dump

Some fun with ``gdb`` to explore memory

```
gef➤  ptype/o JSC::JSValue
/* offset    |  size */  type = class JSC::JSValue {
                         public:
                           static const unsigned int numberOfInt52Bits;
                           static const int64_t notInt52;
                           static const unsigned int int52ShiftAmount;
                         private:
/*    0      |     8 */    union JSC::EncodedValueDescriptor {
/*                 8 */        int64_t asInt64;
/*                 8 */        class JSC::JSCell *ptr;
/*                 8 */        struct {
/*    0      |     4 */            int32_t payload;
/*    4      |     4 */            int32_t tag;

                                   /* total size (bytes):    8 */
                               } asBits;

                               /* total size (bytes):    8 */
                           } u;

                           /* total size (bytes):    8 */
                         }
```

```
gef➤  print *(('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table().key
$93 = {
  <WTF::StringImpl> = {
    static s_flagCount = 0x6,
    static s_flagMask = 0x3f,
    static s_flagStringKindCount = 0x4,
    static s_hashFlagStringKindIsAtomic = 0x10,
    static s_hashFlagStringKindIsSymbol = 0x20,
    static s_hashMaskStringKind = 0x30,
    static s_hashFlag8BitBuffer = 0x8,
    static s_hashFlagDidReportCost = 0x4,
    static s_hashMaskBufferOwnership = 0x3,
    static s_copyCharsInlineCutOff = 0x14,
    static s_refCountFlagIsStaticString = 0x1,
    static s_refCountIncrement = 0x2,
    m_refCount = 0x8a,
    m_length = 0x4,
    {
      m_data8 = 0x55b297a7cf94 "name!",
      m_data16 = 0x55b297a7cf94
    },
    m_hashAndFlags = 0x21792658
  }, <No data fields>}
gef➤  print (('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table()[2].key.m_data8
$100 = (const LChar *) 0x55b297a7cdf4 "length"
gef➤  print (('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table()[3].key.m_data8
$101 = (const LChar *) 0x55b297afcdf4 "getOwnPropertySymbols"
gef➤  print (('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table()[4].key.m_data8
$102 = (const LChar *) 0x7faa08cb45a1 "PrivateSymbol.getPrototypeOf"
gef➤  print (('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table()[5].key.m_data8
$103 = (const LChar *) 0x7faa08cb45d8 "PrivateSymbol.getOwnPropertyNames"
gef➤  print (('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table()[6].key.m_data8
$104 = (const LChar *) 0x55b297a861a4 "defineProperty"
gef➤  print (('JSC::PropertyTable'*)m_propertyTableUnsafe.m_cell)->table()[7].key.m_data8
$105 = (const LChar *) 0x55b297a83014 "getOwnPropertyNames"
```

```
gef➤  print **(('JSC::JSCell'**) (0x000055b297a72520 - (0x8*(0 + 2))))
$143 = {
  static StructureFlags = 0x0, 
  static needsDestruction = 0x0, 
  static TypedArrayStorageType = JSC::NotTypedArray, 
  m_structureID = 0x4, 
  m_indexingType = 0x0, 
  m_type = JSC::StringType, 
  m_flags = 0x38, 
  m_cellState = JSC::CellState::NewWhite
}
gef➤  print **(('JSC::JSCell'**) (0x000055b297a72520 - (0x8*(1 + 2))))
$144 = {
  static StructureFlags = 0x0, 
  static needsDestruction = 0x0, 
  static TypedArrayStorageType = JSC::NotTypedArray, 
  m_structureID = 0x40, 
  m_indexingType = 0x0, 
  m_type = JSC::ObjectType, 
  m_flags = 0x0, 
  m_cellState = JSC::CellState::NewWhite
}
gef➤  print **(('JSC::JSCell'**) (0x000055b297a72520 - (0x8*(2 + 2))))
Cannot access memory at address 0xffff000000000001
gef➤  print **(('JSC::JSCell'**) (0x000055b297a72520 - (0x8*(3 + 2))))
$145 = {
  static StructureFlags = 0x0, 
  static needsDestruction = 0x0, 
  static TypedArrayStorageType = JSC::NotTypedArray, 
  m_structureID = 0x39, 
  m_indexingType = 0x0, 
  m_type = JSC::JSFunctionType, 
  m_flags = 0xa, 
  m_cellState = JSC::CellState::NewWhite
}
```

```
gef➤  p 0x000055b297ad8160 & ~((16*1024) - 1)
$150 = 0x55b297ad8000
gef➤  print *('JSC::MarkedBlock'*)0x55b297ad8000
$151 = {
  <WTF::DoublyLinkedListNode<JSC::MarkedBlock>> = {<No data fields>}, 
  members of JSC::MarkedBlock: 
  static atomSize = 0x10, 
  static blockSize = 0x4000, 
  static blockMask = 0xffffffffffffc000, 
  static atomsPerBlock = 0x400, 
  static atomAlignmentMask = 0xf, 
  m_prev = 0x0, 
  m_next = 0x0, 
  m_atomsPerCell = 0x3, 
  m_endAtom = 0x3fe, 
  m_marks = {
    static wordSize = 0x8, 
    static words = 0x80, 
    static one = <optimized out>, 
    bits = {
      _M_elems = '\000' <repeats 127 times>
    }
  }, 
  m_newlyAllocated = Python Exception <class 'TypeError'> expected string or bytes-like object: 
{
    _M_t = std::tuple containing = {
      [1] = 0x0,
      [2] = {
        <std::default_delete<WTF::Bitmap<1024ul, (WTF::BitmapAtomicMode)0, unsigned int> >> = {<No data fields>}, <No data fields>}
    }
  }, 
  m_capacity = 0x4000, 
  m_needsDestruction = 0x0, 
  m_allocator = 0x55b297a60e90, 
  m_state = JSC::MarkedBlock::FreeListed, 
  m_weakSet = {
    m_allocator = 0x55b297a9e888, 
    m_nextAllocator = 0x0, 
    m_blocks = {
      m_head = 0x55b297a9e4e0, 
      m_tail = 0x55b297a9e4e0
    }, 
    m_vm = 0x55b297a5ec00, 
    m_markedBlock = @0x55b297ad8000
  }
}
gef➤  print (('JSC::MarkedBlock'*)0x55b297ad8000)->m_weakSet.m_vm->heap->structureIDTable
$157 = {JSC::StructureIDTable &(JSC::Heap * const)} 0x55b2966b6e46 <JSC::Heap::structureIDTable()>
gef➤  print (('JSC::MarkedBlock'*)(0x55ba1aa901c0 & ~(16*1024 - 1)))->m_weakSet.m_vm->heap->m_structureIDTable 
$3 = {
  static s_initialSize = 0x100, 
  m_oldTables = {
    <WTF::VectorBuffer<std::unique_ptr<JSC::StructureIDTable::StructureOrOffset [], std::default_delete<JSC::StructureIDTable::StructureOrOffset []> >, 0ul>> = {
      <WTF::VectorBufferBase<std::unique_ptr<JSC::StructureIDTable::StructureOrOffset [], std::default_delete<JSC::StructureIDTable::StructureOrOffset []> > >> = {
        m_buffer = 0x55ba1aa00fd0, 
        m_capacity = 0x10, 
        m_size = 0x1
      }, <No data fields>}, <No data fields>}, 
  m_firstFreeOffset = 0x0, 
  m_table = Python Exception <class 'TypeError'> expected string or bytes-like object: 
{
    _M_t = std::tuple containing = {
      [1] = 0x55ba1aac5db0,
      [2] = {
        <std::default_delete<JSC::StructureIDTable::StructureOrOffset []>> = {<No data fields>}, <No data fields>}
    }
  }, 
  m_size = 0x142, 
  m_capacity = 0x200, 
  static s_unusedID = 0xd1e7beef
}
gef➤  print (('JSC::MarkedBlock'*)(0x55ba1aa901c0 & ~(16*1024 - 1)))->m_weakSet.m_vm->heap->m_structureIDTable.m_table.get()[314]
$10 = {
  structure = 0x55ba1aad1f80,
  offset = 0x1aad1f80
}
```

```
Object.getOwnPropertyDescriptor(obj, 'a')
{value: 1, writable: true, enumerable: true, configurable: true}
Object.getOwnPropertyDescriptors(obj)
{a: {…}, b: {…}, c: {…}}a: {value: 1, writable: true, enumerable: true, configurable: true}b: {value: 2, writable: true, enumerable: true, configurable: true}c: {value: 3, writable: true, enumerable: true, configurable: true}__proto__: Object
```
