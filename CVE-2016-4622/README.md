# CVE-2016-4622

It seems that the 2.6.2+dfsg1-4 Debian's package (from jessie distribution is vulnerable) but in reality
should be the ``2.12.3-1`` (looking directly to the source code log).

The git url for the source code is the following (note the we need to
change working directory)

```
$ git clone https://salsa.debian.org/webkit-team/webkit webkit-debian && cd webkit-debian
```

you need to checkout the tag ``debian/2.12.3-1`` to reproduce the vulnerable code.

I prepared a ``Dockerfile`` to build from the ``WebKit`` source tree:

```
$ docker build -f - . -t gipi/webkit-cve < ${PATH_TO_REPO}/CVE-2016-4622/Dockerfile
$ docker run -it -v $PWD:$PWD gipi/webkit-cve
```

**Note:** mount as a volume also the parent directory of the webkit source tree
otherwise the resulting deb packages will remain in the container

**building with debug enabled fails** https://bugs.webkit.org/show_bug.cgi?id=118281

at the end you should have the binary debian packages built with the debug symbols.

So now you can test the vulnerability in Linux using ``epiphany-browser`` as client for WebKit:

```
$ docker run -it \
    -e LD_LIBRARY_PATH=$PWD/obj-x86_64-linux-gnu/lib \
    -e DISPLAY=$DISPLAY \
    -v /tmp/.X11-unix/:/tmp/.X11-unix/ \
    -v  $PWD:$PWD \
    --entrypoint epiphany \
    gipi/webkit-cve
```
if all is ok you can obtain the following output from the PoC linked below

```
[*] Setting up container object
[*] Fake JSObject @ 0x00007fd56c9fc7d0
[*] Float64Array structure ID found: 00001000
[<] Reading 8 bytes from 0x00007fd56f5da100
[>] Writing 8 bytes to 0x00007fd56c9fc7c0
[<] Reading 16 bytes from 0x00007fd56c9ea380
[>] Writing 16 bytes to 0x00007fd56c9fc7d0
[>] Writing 8 bytes to 0x00007fd56c9fc7e8
[+] All done!
[+] Shellcode function object @ 0x00007fd56c9e10c0
[<] Reading 8 bytes from 0x00007fd56c9e10d8
[+] Executable instance @ 0x00007fd56f585e60
[<] Reading 8 bytes from 0x00007fd56f585e70
[+] JITCode instance @ 0x00007fd56cd64a78
[<] Reading 8 bytes from 0x00007fd56cd64a98
[+] RWX memory @ 0x00007fd570006669
[+] Writing shellcode...
[>] Writing 3 bytes to 0x00007fd570006669
[!] Jumping into shellcode...
```

out of the box the exploit makes ``SIGTRAP`` the renderer process.

You can also use the javascript console directly via command line using ``jsc``

```
$ ./obj-x86_64-linux-gnu/bin/jsc /opt/jscpwn/pwn.js /opt/jscpwn/utils.js  /opt/jscpwn/int64.js  -i
>>> isVulnerable()
true
```

## Fix

This is the patch at ``650552a6ed7ca`` that fixes the vulnerability

```patch
-------------- Source/JavaScriptCore/runtime/ArrayPrototype.cpp ---------------
index cfdd7fceb7f..08a6ec991af 100644
@@ -863,7 +863,7 @@ EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)
     if (UNLIKELY(speciesResult.first == SpeciesConstructResult::Exception))
         return JSValue::encode(jsUndefined());
 
-    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj))) {
+    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj) && length == getLength(exec, thisObj))) {
         if (JSArray* result = asArray(thisObj)->fastSlice(*exec, begin, end - begin))
             return JSValue::encode(result);
     }
@@ -932,7 +932,7 @@ EncodedJSValue JSC_HOST_CALL arrayProtoFuncSplice(ExecState* exec)
         return JSValue::encode(jsUndefined());
 
     JSObject* result = nullptr;
-    if (speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj))
+    if (speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj) && length == getLength(exec, thisObj))
         result = asArray(thisObj)->fastSlice(*exec, begin, deleteCount);
```


## Debugging

Obviously attaching ``gdb`` directly to ``epiphany`` doesn't catch the ``SIGTRAP`` raised
from the PoC, indeed [exists another process](http://higepon.hatenablog.com/entry/20111212/1323695799)

```
$ docker exec -it <container id> /bin/bash
$ ps afx
 ...
27 ?        Sl     0:00 /usr/lib/x86_64-linux-gnu/webkit2gtk-4.0/WebKitNetworkProcess 14
28 ?        Sl     0:00 /usr/lib/x86_64-linux-gnu/webkit2gtk-4.0/WebKitWebProcess 19
 ...
```

we are interested in ``WebKitWebProcess``!

But the preferred way is to use ``jsc``: do not write directly the object into
the ``describe()`` otherwise the garbage collector trashes the memory (I think).

```
>>> a = [1, 2, 3]
1,2,3
>>> describe(a)
Cell: 0x564d3e213c90 (0x564d3e1b0400:[Array, {}, ArrayWithInt32, Proto:0x564d3e1fb6d0]), ID: 120
```

and from ``gdb``

```
gef➤  x/8gx 0x564d3e213c90
0x564d3e213c90: 0x0108150500000078      0x0000564d3e196560 <------ butterfly
0x564d3e213ca0: 0x0108150500000078      0x0000564d3e196538         |
0x564d3e213cb0: 0x0108150500000078      0x0000564d3e196510         |
0x564d3e213cc0: 0x0108150b0000007b      0x0000564d3e1964d8         |
gef➤  x/8gx 0x0000564d3e196560 <-----------------------------------'
0x564d3e196560: 0xffff000000000001      0xffff000000000002
0x564d3e196570: 0xffff000000000003      0x0000000000000000
0x564d3e196580: 0x0000000000000000      0x0000000000000000
0x564d3e196590: 0x0000000000000000      0x0000000000000000
```

```
>>> a = {a: 1, b:2, c:3}
[object Object]
>>> describe(a)
Cell: 0x55e56899be40 (0x55e5689e8d00:[Object, {a:0, b:1, c:2}, NonArray, Proto:0x55e5689c3ff0, Leaf]), ID: 348
```

```
gef➤  x/60xg 0x55e56899be40
0x55e56899be40: 0x010016000000015c      0x0000000000000000
0x55e56899be50: 0xffff000000000001      0xffff000000000002
0x55e56899be60: 0xffff000000000003      0x0000000000000000
0x55e56899be70: 0x0000000000000000      0x0000000000000000
gef➤  print *('JSC::JSCell'*) 0x55e56899be40
$9 = {
  static StructureFlags = 0x0, 
  static needsDestruction = 0x0, 
  static TypedArrayStorageType = JSC::NotTypedArray, 
  m_structureID = 0x15c, 
  m_indexingType = 0x0, 
  m_type = JSC::FinalObjectType, 
  m_flags = 0x0, 
  m_cellState = JSC::CellState::NewWhite
}
```

## Links

 - [Phrack article](http://phrack.com/papers/attacking_javascript_engines.html)
 - [PoC](https://github.com/saelo/jscpwn)
 - [Setup and Debug JavaScriptCore / WebKit - browser 0x01](https://liveoverflow.com/setup-and-debug-javascriptcore-webkit-browser-0x01/) for CVE-2018-4233
 - [Webkit Exploitation Tutorial](http://www.auxy.xyz/modern%20binary%20exploitation/2018/12/05/Webkit-Exp-Tutorial.html)
 - [JSC tales](https://objectivebythesea.com/v2/talks/OBTS_v2_Todesco.pdf)
 - [Inline Caching in JavaScriptCore](http://www.filpizlo.com/slides/pizlo-icooolps2018-inline-caches-slides.pdf)
 - https://docs.ioin.in/writeup/www.auxy.xyz/_tutorial_Webkit_Exp_Tutorial_/index.html
 - [Attributes of object properties in JavaScript](https://2ality.com/2019/11/object-property-attributes.html)
 - [ES6 Feature Complete](https://webkit.org/blog/6756/es6-feature-complete/)
 - [Debian security tracker](https://security-tracker.debian.org/tracker/CVE-2016-4622)
 - [Debian gitlab repo](https://salsa.debian.org/webkit-team/webkit)
 - [Thinking outside the JIT Compiler: Understanding and bypassing StructureID
Randomization with generic and old-school methods](https://i.blackhat.com/eu-19/Thursday/eu-19-Wang-Thinking-Outside-The-JIT-Compiler-Understanding-And-Bypassing-StructureID-Randomization-With-Generic-And-Old-School-Methods.pdf)
 - https://labs.f-secure.com/archive/some-brief-notes-on-webkit-heap-hardening/

