# CVE-2016-4622

It seems that the 2.6.2+dfsg1-4 Debian's package (from jessie distribution is vulnerable) but in reality
should be the ``2.12.3-1`` (looking directly to the source code log).

The git url for the source code is the following

```
$ git clone https://salsa.debian.org/webkit-team/webkit webkit-debian && cd webkit-debian
```

you need to checkout the tag ``debian/2.12.3-1`` to reproduce the vulnerable code.

I prepared a ``Dockerfile`` to build from the ``WebKit`` source tree:

```
$ docker build -f - . -t gipi/webkit-cve < CVE-2016-4622/Dockerfile
$ docker run -it -v $PWD:$PWD gipi/webkit-cve
```

at the end you should have the binary debian packages built with the debug symbols.

So now you can test the vulnerability in Linux using ``epiphany-browser`` as client for WebKit:

```
$ docker run -it \
    -e LD_LIBRARY_PATH=$PWD/obj-x86_64-linux-gnu/lib \
    -e DISPLAY=$DISPLAY \
    -v /tmp/.X11-unix/:/tmp/.X11-unix/ \
    -v  $PWD:$PWD \
    --entrypoint epiphany \
    gipi/webkit-cve
```
if all is ok you can obtain the following output from the PoC linked below

```
[*] Setting up container object
[*] Fake JSObject @ 0x00007fd56c9fc7d0
[*] Float64Array structure ID found: 00001000
[<] Reading 8 bytes from 0x00007fd56f5da100
[>] Writing 8 bytes to 0x00007fd56c9fc7c0
[<] Reading 16 bytes from 0x00007fd56c9ea380
[>] Writing 16 bytes to 0x00007fd56c9fc7d0
[>] Writing 8 bytes to 0x00007fd56c9fc7e8
[+] All done!
[+] Shellcode function object @ 0x00007fd56c9e10c0
[<] Reading 8 bytes from 0x00007fd56c9e10d8
[+] Executable instance @ 0x00007fd56f585e60
[<] Reading 8 bytes from 0x00007fd56f585e70
[+] JITCode instance @ 0x00007fd56cd64a78
[<] Reading 8 bytes from 0x00007fd56cd64a98
[+] RWX memory @ 0x00007fd570006669
[+] Writing shellcode...
[>] Writing 3 bytes to 0x00007fd570006669
[!] Jumping into shellcode...
```

out of the box the exploit makes ``SIGTRAP`` the renderer process.

## Debugging

Obviously attaching ``gdb`` directly to ``epiphany`` doesn't catch the ``SIGTRAP`` raised
from the PoC, indeed [exists another process](http://higepon.hatenablog.com/entry/20111212/1323695799)

```
$ docker exec -it <container id> /bin/bash
$ ps afx
 ...
27 ?        Sl     0:00 /usr/lib/x86_64-linux-gnu/webkit2gtk-4.0/WebKitNetworkProcess 14
28 ?        Sl     0:00 /usr/lib/x86_64-linux-gnu/webkit2gtk-4.0/WebKitWebProcess 19
 ...
```

we are interested in ``WebKitWebProcess``!

## Links

 - [Phrack article](http://phrack.com/papers/attacking_javascript_engines.html)
 - [PoC](https://github.com/saelo/jscpwn)
 - [Debian security tracker](https://security-tracker.debian.org/tracker/CVE-2016-4622)
 - [Debian gitlab repo](https://salsa.debian.org/webkit-team/webkit)

