#!/bin/bash
# inspired by
# <https://www.fragdev.com/blog/using-qemu-inside-terminal-serial-output>

# Save current terminal settings (for restoring later)
STTY_SETTINGS="$( stty -g )"
# Override Ctrl+c and Ctrl+z to prevent killing the VM in horrid ways
# ( Set to right bracket, can be changed if that combination is used )
stty intr ^]
stty susp ^]

qemu-system-x86_64  -s -S \
  -hda amd64-rootfs.ext4   \
  -m 1024 \
  -enable-kvm  \
  -kernel deb-dbg/usr/lib/debug/vmlinux-5.10.0-4-amd64  \
  -initrd /boot/initrd.img-5.10.0-4-amd64  \
  -append 'console=ttyS0 root=/dev/sda rw nokaslr' \
    -device e1000,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
  -device virtio-rng-pci \
  -serial stdio

# Reset the terminal
stty "$STTY_SETTINGS"

