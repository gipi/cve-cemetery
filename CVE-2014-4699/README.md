# CVE-2014-4699

It's a particular vulnerability affecting only Intel CPU implementing
(wrong) the AMD64 specification

A similar vulnerability is the CVE-2012-0217 for the FreeBSD
([this](https://fail0verflow.com/blog/2012/cve-2012-0217-intel-sysret-freebsd/) is the
writeup by failoverflow) with its own PoC that bad enough doesn't work
on Linux since there is a check for not allocating a page adjacent
to non canonical addresses in ``arch/x86/include/asm/processor.h``:

```
/*
 * User space process size.  This is the first address outside the user range.
 * There are a few constraints that determine this:
 *
 * On Intel CPUs, if a SYSCALL instruction is at the highest canonical
 * address, then that syscall will enter the kernel with a
 * non-canonical return address, and SYSRET will explode dangerously.
 * We avoid this particular problem by preventing anything executable
 * from being mapped at the maximum canonical address.
 *
 * On AMD CPUs in the Ryzen family, there's a nasty bug in which the
 * CPUs malfunction if they execute code from the highest canonical page.
 * They'll speculate right off the end of the canonical space, and
 * bad things happen.  This is worked around in the same way as the
 * Intel problem.
 *
 * With page table isolation enabled, we map the LDT in ... [stay tuned]
 */
#define TASK_SIZE_MAX	((1UL << __VIRTUAL_MASK_SHIFT) - PAGE_SIZE)
```

You can replicate the vulnerability in ubuntu 12.04.1 with the kernel
``3.2.0-23-generic #36``.

## Debug symbols

If you want to generate the debug symbols you can use the [Dockerfile](Dockerfile)
in this directory: since there is a limit in the dimension of the
mapping it's more convenient doing the building in an external directory

```
$ docker build -t gipi/cve-2014-4699 .
$ mkdir /path/where/to/build
$ docker run -it -v /path/where/to/build/:/kernel gipi/cve-2014-4699
```
